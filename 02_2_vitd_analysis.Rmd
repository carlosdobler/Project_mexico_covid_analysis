---
title: "Vitamin D Analysis 2"
author: "Carlos Dobler"
date: "`r paste('Last update:', format(Sys.time(), '%B %d %Y (%H:%M)'))`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center')
```


```{r prep, include=FALSE}

library(tidyverse)
library(readxl)

# Load files
read_csv("data/vitd_data/Yan database women 2012 2018 over10 with latitude.csv",
         col_types = "iiiiiddddddii") %>% 
  
  rowwise() %>% 
  mutate(Diab = case_when(all(is.na(c_across(Prediab:Diabet2))) ~ NA_integer_,
                          sum(c_across(Prediab:Diabet2)) == 0 ~ 0L,
                          TRUE ~ 1L
                     )) %>% 
  ungroup() %>% 
  select(-c(Prediab:Diabet2, Year)) %>% 
  rename(Lat = 1) -> df_vitd

# Remove outlier
df_vitd %>% filter(Age >= 20) -> df_vitd

# Is altitude correlated with latitude
# cor.test(df_vitd$Lat, df_vitd$Altitud)


```


## Case-scale analysis

### Pair-wise correlations

#### Latitud
```{r, fig.width = 10, fig.asp = 0.2}

func_pw <- function(df, v){
  
  df %>% 
    pivot_longer(cols = -c(State, Municip, {{v}}),
                 names_to = "vars",
                 values_to = "val") -> d
  
  # d %>%
  #   rename(vv = {{v}}) %>% 
  #   nest(data = (-vars)) %>%
  #   mutate(test = map(data, ~ cor.test(.x$vv, .x$val)),
  #          test = map(test, broom::tidy)) %>%
  #   unnest(cols = test) %>%
  #   select(vars, estimate, p.value) -> d_s
  
  d %>%
    rename(vv = {{v}}) %>% 
    filter(!is.na(vv) & !is.na(val)) %>% 
    group_by(vars) %>% 
    summarize(
      estimate = cor.test(vv, val, use = "complete.obs")$estimate %>% round(2),
      p.value = cor.test(vv, val, use = "complete.obs")$p.value %>% round(2)
    ) -> d_s
  
  ggplot(d, aes(x = {{v}}, y = val)) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "lm", se = F, color = "red") +
    facet_wrap(~vars, nrow = 1, scales = "free_y") +
    geom_label(data = d_s, aes(x = -Inf, y = Inf, label = str_c("r = ", round(estimate, 2), "\np = ", round(p.value, 2))),
               hjust = -0.1, vjust = 1.2, alpha = 0.7) +
    theme(axis.title.y = element_blank())
  
}

func_pw(df_vitd, Lat)

```


#### Age
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_vitd, Age)
```


#### Altitud
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_vitd, Altitud)
```

#### BMI
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_vitd, BMI)
```

#### Diabetes
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_vitd, Diab)
```

#### Hypertension
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_vitd, Hypert)
```

#### Sugar
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_vitd, Sugar)
```

#### Vitamin D
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_vitd, vitD)
```


### Multiple regression
Response variable = vit D  
Explanatory variables = bmi, lat, alt
```{r, include=FALSE}

# df_vitd %>% 
#   map_df(~sum(!is.na(.x))) # count missing obs per var
# 
# df_vitd %>%
#   select(BMI, Lat, Altitud) %>%
#   rowwise() %>% 
#   mutate(na = case_when(any(is.na(c_across(everything()))) ~ 0,
#                         TRUE ~ 1)) %>% 
#   ungroup() %>% 
#   filter(na == 1) %>% 
#   select(-c(State, Municip, na)) %>% # remove: highest num of missing obs
#   
#   mutate(Hypert = factor(Hypert),
#          Diab = factor(Diab)) -> d
# 
# d[,-1] %>% 
#   mutate(across(everything(), ~as.numeric(.x))) %>% 
#   corrr::correlate() %>% 
#   corrr::shave()
  

```

```{r, include=F}

#lm(vitD ~ BMI + , data = d) %>% summary()

```
Impossible: not enough observations.


## Municipal-scale analysis
```{r, include = FALSE}

read_excel("data/vitd_data/Municipal database 20 to 49_MS&YG version2.xlsx",
           skip = 1,
           col_names = c("State", "Municip", "State_name", "Mun_name", "Deaths", 
                         "Pop", "Deaths_ht", "Alt", "Lat", "Ethnicity", "x")) %>% 
  select(-x) -> df_mun

df_vitd %>% 
  group_by(State, Municip) %>% 
  summarize(
    sample_size = n(),
    mean_vitD = mean(vitD),
    nmol_30 = sum(vitD < 30)/n(),
    nmol_50 = sum(vitD < 50)/n(),
    nmol_75 = sum(vitD < 75)/n()
  ) %>% 
  
  {right_join(df_mun, ., by = c("State", "Municip"))} -> df_mun

```

### Pair-wise correlations

#### Deaths per 100,000
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_mun[,-c(3:6,11)], Deaths_ht)
```

#### Altitude
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_mun[,-c(3:6,11)], Alt)
```

#### Latitude
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_mun[,-c(3:6,11)], Lat)
```

#### Ethnicity
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_mun[,-c(3:6,11)], Ethnicity)
```

#### Mean Vit D
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_mun[,-c(3:6,11)], mean_vitD)
```

#### nmol < 30
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_mun[,-c(3:6,11)], nmol_30)
```

#### nmol < 50
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_mun[,-c(3:6,11)], nmol_50)
```

#### nmol < 75
```{r, fig.width = 10, fig.asp = 0.2}
func_pw(df_mun[,-c(3:6,11)], nmol_75)
```

## Multivariate regression 1
Response variable = mean Vit D  
Explanatory variables = Deaths per 100,000, Altitude, Latitude, & Ethnicity
```{r}

# df_mun[,7:10] %>%
#   corrr::correlate() %>%
#   corrr::shave()

lm(mean_vitD ~ Deaths_ht + Alt + Lat + Ethnicity, data = df_mun) %>% summary()

```
Explanatory variables, together, explain 30% of the variance in Vit D at municipal scale. When controlling for other variables, each variable shows a negative relation with vit D, but only deaths per 100,000, altitude, and latitude are significant. If ethnicity is removed from the model, results are almost the same in terms of coefficients, their signs, and R2.

## Multivariate regression 2
Response variable = Deaths per 100,000  
Explanatory variables = Altitude and Latitude
```{r}

lm(Deaths_ht ~ Alt + Lat, data = df_mun) %>% summary()

```

## Multivariate regression 3
Response variable = Deaths per 100,000  
Explanatory variables = Altitude, Latitude, nmol < 30
```{r}

lm(Deaths_ht ~ Alt + Lat + nmol_30, data = df_mun) %>% summary()

```

