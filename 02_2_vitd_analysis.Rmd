---
title: "Vitamin D Analysis 2"
author: "Carlos Dobler"
date: "`r paste('Last update:', format(Sys.time(), '%B %d %Y (%H:%M)'))`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center')
```


```{r prep, include=FALSE}

library(tidyverse)
library(readxl)
library(patchwork)

# Load files
read_excel("data/vitd_data/state muncip alt and lat.xlsx") %>% 
  slice(-1) %>% 
  rename(State = 1,
         Municip = 2,
         Altitude2 = 3,
         Lat = 4) -> df_latalt
  
# Main data: younger women
read_csv("data/vitd_data/Yan database women 2012 2018 over10 with lat and alt.csv") %>% 
  
  rowwise() %>% 
  mutate(Diab = case_when(all(is.na(c_across(Prediab:Diabet2))) ~ NA,
                          sum(c_across(Prediab:Diabet2)) == 0 ~ F,
                          TRUE ~ T
                     )) %>% 
  ungroup() %>% 
  select(-c(Prediab:Diabet2, Year)) %>% 
  
  mutate(Hypert = as.logical(Hypert)) %>%
  
  rename(Lat_zone = 1) -> df_vitd

# Remove outlier
df_vitd %>% filter(Age >= 20) -> df_vitd

df_vitd %>% 
  left_join(df_latalt, by = c("State", "Municip")) -> df_vitd

# older women
read_excel("data/vitd_data/Women over 60.xlsx") %>%
  filter(SEXO == 2,
         EDAD >= 60) %>% 
  select(-c(1,3,9,10)) %>%
  rename(Age = 1,
         State = 2,
         Municip = 3,
         Lat_zone = 4,
         Altitude = 5,
         vitD = 6) %>%

  group_by(State, Municip) %>%
  mutate(n = n()) %>%
  filter(n >= 10) %>%
  ungroup() %>%
  select(-n) -> df_60

df_60 %>% 
  left_join(df_latalt, by = c("State", "Municip")) -> df_60

df_60 %>% 
  mutate(BMI = NA,
         Hypert = NA,
         Sugar = NA,
         Diab = NA) %>% 
  select(names(df_vitd)) %>% 
  bind_rows(df_vitd) -> df_vitd_60

# Is altitude correlated with latitude
# cor.test(df_vitd$Lat, df_vitd$Altitud)


```


## Individual-scale analysis

### Pair-wise correlations
Between continuous variables: Pearson  
Between a binary and a continuous variable: Mann-Whitney  
Between binary variables: Chi-square  

#### Latitude
```{r, fig.width = 10, fig.asp = 0.2}

# func_pw <- function(df, v){
#   
#   df %>% 
#     pivot_longer(cols = -c(State, Municip, {{v}}),
#                  names_to = "vars",
#                  values_to = "val") -> d
#   
#   d %>%
#     rename(vv = {{v}}) %>%
#     nest(data = (-vars)) %>%
#     mutate(test = map(data, ~ cor.test(.x$vv, .x$val)),
#            test = map(test, broom::tidy)) %>%
#     unnest(cols = test) %>%
#     select(vars, estimate, p.value) -> d_s
#   
#   d %>%
#     rename(vv = {{v}}) %>% 
#     filter(!is.na(vv) & !is.na(val)) %>% 
#     group_by(vars) %>% 
#     summarize(
#       estimate = cor.test(vv, val, use = "complete.obs")$estimate %>% round(2),
#       p.value = cor.test(vv, val, use = "complete.obs")$p.value %>% round(2)
#     ) -> d_s
#   
#   ggplot(d, aes(x = {{v}}, y = val)) +
#     geom_point(alpha = 0.5) +
#     geom_smooth(method = "lm", se = F, color = "red") +
#     facet_wrap(~vars, nrow = 1, scales = "free_y") +
#     geom_label(data = d_s, aes(x = -Inf, y = Inf, label = str_c("r = ", round(estimate, 2), "\np = ", round(p.value, 2))),
#                hjust = -0.1, vjust = 1.2, alpha = 0.7) +
#     theme(axis.title.y = element_blank())
#   
# }


func_pw2 <- function(df, v){
  
  df %>% 
    select(-c(all_of(v))) %>% 
    names() %>% 
    # .[7] %>% # DEL
    map(function(c){
      
      # Both numeric = pearson
      if(is.numeric(df %>% pull(v)) & is.numeric(df %>% pull(c))){
        
        t <- cor.test(df %>% pull(v), df %>% pull(c))
        
        d_s <- tibble(estimate = t$estimate %>% round(2),
                      p.value = t$p.value %>% round(2))
        
        ggplot(df, aes(x = .data[[v]], y = .data[[c]])) +
          geom_point(alpha = 0.5) +
          geom_smooth(method = "lm", se = F, color = "red") +
          # geom_label(data = d_s, aes(x = -Inf, y = Inf, label = str_c("r = ", round(estimate, 2), "\np = ", round(p.value, 2))),
          #      hjust = -0.1, vjust = 1.2, alpha = 0.7)
          labs(caption = str_c("r = ", d_s$estimate, "; p = ", d_s$p.value),
               subtitle = c) +
          theme(axis.title = element_blank())
          
      # Numeric + logical = wilcoxon (mann-whitney)
      } else if(is.numeric(df %>% pull(v)) & is.logical(df %>% pull(c))){
        
        t <- wilcox.test(df %>% pull(v) ~ df %>% pull(c))
        
        d_s <- t$p.value %>% round(2)
        
        df %>% 
          filter(!is.na(.data[[v]]), !is.na(.data[[c]])) %>%
          ggplot(aes(x = .data[[v]], y = .data[[c]])) +
          geom_boxplot() +
          # geom_label(aes(x = -Inf, y = Inf, label = str_c("p = ", round(d_s, 2))),
          #      hjust = -0.1, vjust = 1.2, alpha = 0.7)
          labs(caption = str_c("p = ", d_s),
               subtitle = c) +
          theme(axis.title = element_blank())
        
        
      # Logical + logical = chi sq
      } else if(is.logical(df %>% pull(v)) & is.logical(df %>% pull(c))){
        
        t <- chisq.test(df %>% pull(v), df %>% pull(c))
        
        d_s <- t$p.value %>% round(2)
        
        df %>% 
          filter(!is.na(.data[[v]]), !is.na(.data[[c]])) %>% 
          count(.data[[v]], .data[[c]]) %>% 
          ggplot(aes(.data[[v]], .data[[c]])) +
          geom_tile(aes(fill = n), show.legend = F) + 
          geom_label(aes(label = n)) +
          labs(caption = str_c("p = ", d_s),
               subtitle = c) +
          theme(axis.title = element_blank())
        
      # Logical + numeric
      } else if(is.logical(df %>% pull(v)) & is.numeric(df %>% pull(c))){
        
        t <- wilcox.test(df %>% pull(c) ~ df %>% pull(v))
        
        d_s <- t$p.value %>% round(2)
        
        df %>% 
          filter(!is.na(.data[[v]]), !is.na(.data[[c]])) %>%
          ggplot(aes(x = .data[[v]], y = .data[[c]])) +
          geom_boxplot() +
          # geom_label(aes(x = -Inf, y = Inf, label = str_c("p = ", round(d_s, 2))),
          #      hjust = -0.1, vjust = 1.2, alpha = 0.7)
          labs(caption = str_c("p = ", d_s),
               subtitle = c) +
          theme(axis.title = element_blank())
        
      }
      
    }) %>% 
    
    wrap_plots(nrow = 1)
    
}

func_pw2(df_vitd_60[,-c(1:3,11)], "Lat")

```


#### Age
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_vitd_60[,-c(1:3,11)], "Age")
```


#### Altitud
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_vitd_60[,-c(1:3,11)], "Altitude")
```

#### BMI
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_vitd_60[,-c(1:3,11)], "BMI")
```

#### Diabetes
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_vitd_60[,-c(1:3,11)], "Diab")
```

#### Hypertension
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_vitd_60[,-c(1:3,11)], "Hypert")
```

#### Sugar
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_vitd_60[,-c(1:3,11)], "Sugar")
```

#### Vitamin D
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_vitd_60[,-c(1:3,11)], "vitD")
```


### Multiple regression 1
Response variable = vit D  
Explanatory variables = bmi, lat, alt
Only using data of women 20-49 (no BMI data for > 60)
```{r, include=FALSE}

# df_vitd %>%
#   map_df(~sum(is.na(.x))) # count missing obs per var
# 
# df_vitd %>%
#   select(BMI, Lat_zone, Altitude) %>%
#   rowwise() %>%
#   mutate(na = case_when(any(is.na(c_across(everything()))) ~ 0,
#                         TRUE ~ 1)) %>%
#   ungroup() %>%
#   filter(na == 1) %>%
#   select(-na)
# 
# d[,-1] %>%
#   mutate(across(everything(), ~as.numeric(.x))) %>%
#   corrr::correlate() %>%
#   corrr::shave()


```

```{r}

lm(vitD ~ BMI + Lat + Altitude, data = df_vitd) %>% summary()

```

### Multiple regression 2
Response variable = vit D  
Explanatory variables = lat, alt
Using all data (ages 20 - > 60)
```{r}

lm(vitD ~ Lat + Altitude, data = df_vitd_60) %>% summary()

```




## Municipal-scale analysis
```{r, include = FALSE}

read_excel("data/vitd_data/Municipal database 20 to 49_MS&YG version2.xlsx",
           skip = 1) %>% 
  rename_with(~c("State", "Municip", "State_name", "Mun_name", "Deaths", 
                         "Pop", "Deaths_ht", "Alt", "Lat", "Ethnicity", "x")) %>% 
  select(-x) -> df_mun

df_vitd_60 %>% 
  group_by(State, Municip) %>% 
  summarize(
    sample_size = n(),
    mean_vitD = mean(vitD),
    nmol_30 = sum(vitD < 30)/n(),
    nmol_50 = sum(vitD < 50)/n(),
    nmol_75 = sum(vitD < 75)/n()
  ) %>% 
  
  {right_join(df_mun, ., by = c("State", "Municip"))} -> df_mun

```

### Pair-wise correlations

#### Deaths per 100,000
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_mun[,-c(1:6,11)], "Deaths_ht")
```

#### Altitude
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_mun[,-c(1:6,11)], "Alt")
```

#### Latitude
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_mun[,-c(1:6,11)], "Lat")
```

#### Ethnicity
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_mun[,-c(1:6,11)], "Ethnicity")
```

#### Mean Vit D
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_mun[,-c(1:6,11)], "mean_vitD")
```

#### nmol < 30
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_mun[,-c(1:6,11)], "nmol_30")
```

#### nmol < 50
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_mun[,-c(1:6,11)], "nmol_50")
```

#### nmol < 75
```{r, fig.width = 10, fig.asp = 0.2}
func_pw2(df_mun[,-c(1:6,11)], "nmol_75")
```

## Multivariate regression 1
Response variable = mean Vit D  
Explanatory variables = Deaths per 100,000, Altitude, Latitude, & Ethnicity
```{r}

# df_mun[,7:10] %>%
#   corrr::correlate() %>%
#   corrr::shave()

lm(mean_vitD ~ Deaths_ht + Alt + Lat + Ethnicity, data = df_mun) %>% summary()

```
Explanatory variables, together, explain 30% of the variance in Vit D at municipal scale. When controlling for other variables, each variable shows a negative relation with vit D, but only deaths per 100,000, altitude, and latitude are significant. If ethnicity is removed from the model, results are almost the same in terms of coefficients, their signs, and R2.

## Multivariate regression 2
Response variable = Deaths per 100,000  
Explanatory variables = Altitude and Latitude
```{r}

lm(Deaths_ht ~ Alt + Lat, data = df_mun) %>% summary()

```

## Multivariate regression 3
Response variable = Deaths per 100,000  
Explanatory variables = Altitude, Latitude, nmol < 30
```{r}

lm(Deaths_ht ~ Alt + Lat + nmol_30, data = df_mun) %>% summary()

```

